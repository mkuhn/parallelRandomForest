# library(randomForest)
library(parallelRandomForest)
# library(testthat)

aq <- airquality[ which( apply(airquality, 1, function(row) sum(is.na(row)) ) == 0), ]

ozone <- aq$Ozone
aq$Solar.R  <- aq$Solar.R / 2
aq$Wind  <- 10*aq$Wind


x_raw <- as.matrix( aq[,2:6] )
storage.mode(x_raw) <- "raw"
set.seed(131)
rf_raw <- randomForest(x=x_raw, y=ozone, xtest=x_raw, mtry=3, importance=F, na.action=na.omit, keep.forest=T)

x <- as.matrix( aq[,2:6] )
set.seed(131)
rf_double <- randomForest(x=x, y=ozone, xtest=x, mtry=3, importance=F, na.action=na.omit, keep.forest=T)

# dput(rf_raw$predicted)
# dput(rf_double$predicted)
# print(rf_raw)

expected_prediction_double <- structure(c(33.190524534687, 25.8965355805244, 25.9410112359551,
                                          23.8859848484849, 25.361865942029, 18.0410194174757, 14.5604575163398,
                                          19.0988304093568, 22.8469101123596, 18.9712871287129, 12.4364705882353,
                                          25.4474719101124, 17.5685185185185, 19.6795580110498, 20.6794017094017,
                                          10.6847222222222, 14.5552083333333, 25.7089318600368, 12.5536057692307,
                                          14.6488413547237, 13.4388576779026, 45.7702247191011, 58.6634502923977,
                                          36.1252577319588, 29.7263414634147, 66.0473415132925, 61.5608237547893,
                                          35.9542592592593, 20.1936936936937, 15.7308139534884, 14.6512380952381,
                                          18.3780303030303, 21.1281310211946, 87.3290502793295, 69.5094594594594,
                                          40.2359744990893, 90.4878431372548, 45.2882556131261, 89.0378431372548,
                                          86.7912037037036, 87.3576271186439, 83.77581300813, 19.506369982548,
                                          37.9040489642185, 26.5588951310862, 50.0146907216495, 36.602178030303,
                                          76.5356287425149, 78.274537037037, 57.3573333333334, 28.034954954955,
                                          65.1084642233857, 64.6383913764511, 33.9806921675774, 49.7497409326425,
                                          74.0285310734463, 75.0539594843462, 53.2430051813472, 45.9126315789474,
                                          34.7490549828179, 22.1679718875502, 31.5783132530121, 110.109965635739,
                                          74.1836956521739, 82.3465136054421, 57.8369047619048, 33.8503683241252,
                                          29.4791018998273, 15.030938697318, 48.081884057971, 27.3063953488372,
                                          34.6548821548822, 28.9240069084629, 21.440376984127, 12.5884831460674,
                                          43.5578947368421, 83.8880239520957, 79.8973118279569, 79.1599999999999,
                                          112.887142857143, 92.8387005649716, 87.0880692167576, 83.010969387755,
                                          91.145238095238, 121.219688644688, 84.0412234042552, 63.1734104046243,
                                          43.4165745856354, 37.0701570680628, 34.5326958105647, 19.8613496932516,
                                          20.0339605734767, 29.0334307992203, 18.805018939394, 58.4101190476191,
                                          13.007650273224, 18.8061694290976, 36.0258426966292, 19.8906593406594,
                                          13.0081460674157, 19.5760185185185, 48.2487387387387, 22.0465579710145,
                                          13.5149812734082, 32.3435688405797, 17.3391666666667, 15.4816326530612,
                                          34.345810564663, 24.2050802139038, 29.4613553113553, 29.0734082397004
), .Names = c("1", "2", "3", "4", "7", "8", "9", "12", "13",
              "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24",
              "28", "29", "30", "31", "38", "40", "41", "44", "47", "48", "49",
              "50", "51", "62", "63", "64", "66", "67", "68", "69", "70", "71",
              "73", "74", "76", "77", "78", "79", "80", "81", "82", "85", "86",
              "87", "88", "89", "90", "91", "92", "93", "94", "95", "99", "100",
              "101", "104", "105", "106", "108", "109", "110", "111", "112",
              "113", "114", "116", "117", "118", "120", "121", "122", "123",
              "124", "125", "126", "127", "128", "129", "130", "131", "132",
              "133", "134", "135", "136", "137", "138", "139", "140", "141",
              "142", "143", "144", "145", "146", "147", "148", "149", "151",
              "152", "153"))
expected_prediction_raw <- structure(c(29.7761111111111, 25.9064864864865, 24.2793518518519,
                                       22.2230496453901, 22.6056994818653, 17.59199669967, 13.7642628205128,
                                       20.984496124031, 23.2069523809524, 19.5339572192514, 10.5479390681003,
                                       26.3157355679702, 17.2369047619048, 19.0693641618497, 20.5756481481482,
                                       10.3520833333333, 14.2929118773946, 27.0722537878788, 12.8974603174603,
                                       15.0868092691622, 13.078431372549, 44.9172447013488, 59.2734082397004,
                                       33.3604477611941, 28.4178571428572, 69.2822975517891, 60.0277192982456,
                                       35.4035037878788, 20.7242156862746, 15.2358851674641, 13.6048295454545,
                                       17.546881091618, 19.8779761904762, 88.369135802469, 68.5455729166666,
                                       37.7746254681648, 92.2380681818181, 46.2349376114082, 89.7573643410852,
                                       86.419658119658, 88.0229276895943, 84.31408045977, 19.5483065953654,
                                       38.0362573099415, 25.3431034482759, 50.7602763385147, 37.6147435897436,
                                       74.3239711934156, 78.6465069860279, 55.1173469387755, 27.1206773618539,
                                       66.1756684491979, 64.9698453608247, 33.4736434108527, 48.4917862838915,
                                       73.8037832310838, 76.5059198542804, 52.3066479400749, 47.0799813780261,
                                       34.9224470134875, 21.8810313075507, 30.8020958083832, 106.157899807322,
                                       76.5158813263525, 81.1036155202821, 58.2706481481482, 34.7990143369176,
                                       28.3432938856016, 14.2616055846422, 42.3687392055268, 26.1457642725599,
                                       33.1829124579125, 28.4823581560284, 22.2310606060606, 12.7589743589743,
                                       44.7262037037037, 84.2678160919539, 79.8148936170212, 81.0951666666665,
                                       111.25810564663, 90.6021442495126, 85.6784313725489, 79.6727499999999,
                                       89.7887978142075, 118.679894179894, 82.3211169284467, 63.9219191919192,
                                       46.1674603174603, 36.9979742173112, 33.5605311355311, 19.6886666666667,
                                       20.0812834224599, 27.9873456790124, 18.5917613636364, 57.2874531835206,
                                       13.8603130755064, 18.4729281767956, 35.6690751445087, 20.2128571428572,
                                       13.2799145299145, 19.915873015873, 45.5197297297297, 21.8853107344633,
                                       13.4936813186813, 32.6957657657658, 16.4955782312925, 13.9945970695971,
                                       32.0767973856209, 22.3483333333334, 30.0831428571429, 29.6489583333333
), .Names = c("1", "2", "3", "4", "7", "8", "9", "12", "13",
              "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24",
              "28", "29", "30", "31", "38", "40", "41", "44", "47", "48", "49",
              "50", "51", "62", "63", "64", "66", "67", "68", "69", "70", "71",
              "73", "74", "76", "77", "78", "79", "80", "81", "82", "85", "86",
              "87", "88", "89", "90", "91", "92", "93", "94", "95", "99", "100",
              "101", "104", "105", "106", "108", "109", "110", "111", "112",
              "113", "114", "116", "117", "118", "120", "121", "122", "123",
              "124", "125", "126", "127", "128", "129", "130", "131", "132",
              "133", "134", "135", "136", "137", "138", "139", "140", "141",
              "142", "143", "144", "145", "146", "147", "148", "149", "151",
              "152", "153"))


test_that("Predicted regression values", {
  expect_equal(expected_prediction_raw, rf_raw$predicted);
  expect_equal(expected_prediction_double, rf_double$predicted);
} )


